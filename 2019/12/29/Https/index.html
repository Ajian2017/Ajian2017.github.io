<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Https handshake | </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一、SSL协议的握手过程开始加密通信之前，客户端和服务器首先必须建立连接和交换参数，这个过程叫做握手（handshake） 假定客户端叫做爱丽丝，服务器叫做鲍勃，整个握手阶段分成五步: 第一步，爱丽丝给出协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法。 第二步，鲍勃确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（Server rand">
<meta property="og:type" content="article">
<meta property="og:title" content="Https handshake">
<meta property="og:url" content="http://yoursite.com/2019/12/29/Https/index.html">
<meta property="og:site_name" content="">
<meta property="og:description" content="一、SSL协议的握手过程开始加密通信之前，客户端和服务器首先必须建立连接和交换参数，这个过程叫做握手（handshake） 假定客户端叫做爱丽丝，服务器叫做鲍勃，整个握手阶段分成五步: 第一步，爱丽丝给出协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法。 第二步，鲍勃确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（Server rand">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://yoursite.com/images/https_1.png">
<meta property="og:image" content="http://yoursite.com/images/https_2.png">
<meta property="og:image" content="http://yoursite.com/images/https_3.png">
<meta property="og:image" content="http://yoursite.com/images/https_4.png">
<meta property="og:image" content="http://yoursite.com/images/https_5.png">
<meta property="article:published_time" content="2019-12-29T08:39:03.968Z">
<meta property="article:modified_time" content="2019-12-29T09:07:37.897Z">
<meta property="article:author" content="ajian">
<meta property="article:tag" content="https">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/https_1.png">
  
    <link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo"></a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Https" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/29/Https/" class="article-date">
  <time datetime="2019-12-29T08:39:03.968Z" itemprop="datePublished">2019-12-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Https handshake
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一、SSL协议的握手过程"><a href="#一、SSL协议的握手过程" class="headerlink" title="一、SSL协议的握手过程"></a>一、SSL协议的握手过程</h3><p>开始加密通信之前，客户端和服务器首先必须建立连接和交换参数，这个过程叫做握手（handshake）</p>
<h4 id="假定客户端叫做爱丽丝，服务器叫做鲍勃，整个握手阶段分成五步"><a href="#假定客户端叫做爱丽丝，服务器叫做鲍勃，整个握手阶段分成五步" class="headerlink" title="假定客户端叫做爱丽丝，服务器叫做鲍勃，整个握手阶段分成五步:"></a>假定客户端叫做爱丽丝，服务器叫做鲍勃，整个握手阶段分成五步:</h4><ul>
<li>第一步，爱丽丝给出协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法。</li>
<li>第二步，鲍勃确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（Server random）。</li>
<li>第三步，爱丽丝确认数字证书有效，然后生成一个新的随机数（Premaster secret），并使用数字证书中的公钥，加密这个随机数，发给鲍勃。</li>
<li>第四步，鲍勃使用自己的私钥，获取爱丽丝发来的随机数（即Premaster secret）。</li>
<li>第五步，爱丽丝和鲍勃根据约定的加密方法，使用前面的三个随机数，生成”对话密钥”（session key），用来加密接下来的整个对话过程。</li>
</ul>
<h4 id="上面的五步，画成一张图，就是下面这样。"><a href="#上面的五步，画成一张图，就是下面这样。" class="headerlink" title="上面的五步，画成一张图，就是下面这样。"></a>上面的五步，画成一张图，就是下面这样。</h4><p><img src="/images/https_1.png" alt=""></p>
<h3 id="二、私钥的作用"><a href="#二、私钥的作用" class="headerlink" title="二、私钥的作用"></a>二、私钥的作用</h3><h4 id="握手阶段有三点需要注意。"><a href="#握手阶段有三点需要注意。" class="headerlink" title="握手阶段有三点需要注意。"></a>握手阶段有三点需要注意。</h4><ul>
<li><p>(1）生成对话密钥一共需要三个随机数。</p>
</li>
<li><p>(2）握手之后的对话使用”对话密钥”加密（对称加密），服务器的公钥和私钥只用于加密和解密”对话密钥”（非对称加密），无其他作用。</p>
</li>
<li><p>(3）服务器公钥放在服务器的数字证书之中。</p>
<p>  从上面第二点可知，整个对话过程中（握手阶段和其后的对话），服务器的公钥和私钥只需要用到一次。这就是CloudFlare能够提供Keyless服务的根本原因。<br>  某些客户（比如银行）想要使用外部CDN，加快自家网站的访问速度，但是出于安全考虑，不能把私钥交给CDN服务商。这时，完全可以把私钥留在自家服务器，只用来解密对话密钥，其他步骤都让CDN服务商去完成。<br><img src="/images/https_2.png" alt=""><br>上图中，银行的服务器只参与第四步，后面的对话都不再会用到私钥了。</p>
</li>
</ul>
<h3 id="三、DH算法的握手阶段"><a href="#三、DH算法的握手阶段" class="headerlink" title="三、DH算法的握手阶段"></a>三、DH算法的握手阶段</h3><ul>
<li>整个握手阶段都不加密（也没法加密），都是明文的。因此，如果有人窃听通信，他可以知道双方选择的加密方法，以及三个随机数中的两个。整个通话的安全，只取决于第三个随机数（Premaster secret）能不能被破解。</li>
<li>虽然理论上，只要服务器的公钥足够长（比如2048位），那么Premaster secret可以保证不被破解。但是为了足够安全，我们可以考虑把握手阶段的算法从默认的RSA算法，改为 Diffie-Hellman算法（简称DH算法）。</li>
<li>采用DH算法后，Premaster secret不需要传递，双方只要交换各自的参数，就可以算出这个随机数。</li>
</ul>
<p><img src="/images/https_3.png" alt=""></p>
<ul>
<li>上图中，第三步和第四步由传递Premaster secret变成了传递DH算法所需的参数，然后双方各自算出Premaster secret。这样就提高了安全性。</li>
</ul>
<h3 id="四、session的恢复"><a href="#四、session的恢复" class="headerlink" title="四、session的恢复"></a>四、session的恢复</h3><ul>
<li><p>握手阶段用来建立SSL连接。如果出于某种原因，对话中断，就需要重新握手。</p>
</li>
<li><p>这时有两种方法可以恢复原来的session：一种叫做session ID，另一种叫做session ticket。</p>
</li>
<li><p>session ID的思想很简单，就是每一次对话都有一个编号（session ID）。如果对话中断，下次重连的时候，只要客户端给出这个编号，且服务器有这个编号的记录，双方就可以重新使用已有的”对话密钥”，而不必重新生成一把。<br><img src="/images/https_4.png" alt=""></p>
</li>
<li><p>上图中，客户端给出session ID，服务器确认该编号存在，双方就不再进行握手阶段剩余的步骤，而直接用已有的对话密钥进行加密通信。</p>
</li>
<li><p>session ID是目前所有浏览器都支持的方法，但是它的缺点在于session ID往往只保留在一台服务器上。所以，如果客户端的请求发到另一台服务器，就无法恢复对话。session ticket就是为了解决这个问题而诞生的，目前只有Firefox和Chrome浏览器支持。</p>
</li>
</ul>
<p><img src="/images/https_5.png" alt=""></p>
<ul>
<li>上图中，客户端不再发送session ID，而是发送一个服务器在上一次对话中发送过来的session ticket。这个session ticket是加密的，只有服务器才能解密，其中包括本次对话的主要信息，比如对话密钥和加密方法。当服务器收到session ticket以后，解密后就不必重新生成对话密钥了。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/29/Https/" data-id="ckmf115yz00040ujb8e7jhrnx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/https/" rel="tag">https</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/12/29/AppleSign/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          苹果双向签名原理
        
      </div>
    </a>
  
  
    <a href="/2019/12/29/leetcode-contest/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">16场双周赛</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
    
      

    
      
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/" rel="tag">https</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/" rel="tag">iOS</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swift/" rel="tag">swift</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/" rel="tag">tools</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/leetcode/" style="font-size: 20px;">leetcode</a> <a href="/tags/swift/" style="font-size: 20px;">swift</a> <a href="/tags/tools/" style="font-size: 15px;">tools</a>
    </div>
  </div>

    
      
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/18/ffmpeg%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">ffmpeg常用命令</a>
          </li>
        
          <li>
            <a href="/2020/12/19/%E4%B8%80%E4%BA%9BiOS%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">一些iOS常用命令</a>
          </li>
        
          <li>
            <a href="/2020/02/09/LeetCodeContest175/">175场周赛</a>
          </li>
        
          <li>
            <a href="/2020/01/29/BitWeeklyContest18/">18场双周赛</a>
          </li>
        
          <li>
            <a href="/2020/01/26/LeetCodeContest173/">173场周赛</a>
          </li>
        
      </ul>
    </div>
  </div>

    
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=86 
    src="https://music.163.com/outchain/player?type=2&id=1993765&auto=1&height=66">
    </iframe>
  </aside>
  
        
      </div>
      <footer id="footer">
  
  <div class="goBack" onclick="window.scrollTo('0','0')"></div>
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 ajian<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>